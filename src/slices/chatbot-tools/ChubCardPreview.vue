<script setup lang="ts">
import {
  CHUB_TAGS_TO_HIDE,
  chubGetCardByFullPath,
  type ChubCard,
  type ChubCardFullPath,
} from "./chub";
import { computed, inject } from "vue";
import { useQuery } from "@tanstack/vue-query";
import { chubQueryOptions } from "./chubQuery";
import { chubProviderKey } from "./chubProvider";
import { useTimeAgo } from "@vueuse/core";
import { chubMarkdownToHtml } from "./chubMarkdown";
import { downloadFile } from "../../lib/download";
import { chubCardToTavernCardFile } from "./chubPngHelpers";
import { jsonParse } from "../../lib/json";
import {
  chubAddAuthorToUrl,
  chubAddCardFullPathToUrl,
  chubAddTopicToUrl,
} from "./chubHelpers";
import { formatNumberWithMagnitude } from "../../lib/number";

const props = defineProps<{
  card: ChubCard;
  isHiddenInNsfw?: boolean;
  isHiddenInNsfl?: boolean;
}>();
const emit = defineEmits<{
  openInFullscreen: [fullPath: ChubCardFullPath];
  searchByAuthor: [name: string];
  addTopic: [topic: string];
}>();

const configQuery = useQuery(chubQueryOptions("chubFetchEntireConfig", []));
const config = configQuery.data;
const { blurNsfw } = inject(chubProviderKey)!;
const author = computed(() => props.card.fullPath.replace(/[/][\s\S]+/, ""));

const isExplicitNsfw = computed(() => props.card.topics.includes("NSFW"));
const isExplicitNsfl = computed(() => props.card.topics.includes("NSFL"));
const isNsfw = computed(
  () => isExplicitNsfw.value || (props.isHiddenInNsfw ?? false),
);
const isNsfl = computed(
  () => isExplicitNsfl.value || (props.isHiddenInNsfl ?? false),
);
const isShadowNsfw = computed(() => isNsfw.value && !isExplicitNsfw.value);
const isShadowNsfl = computed(() => isNsfl.value && !isExplicitNsfl.value);

const tokenCounts = computed(() => {
  const tokenCountsRaw = props.card.labels?.find(
    (l) => l.title === "TOKEN_COUNTS",
  )?.description;
  if (!tokenCountsRaw) return null;
  const tokenCounts = jsonParse(tokenCountsRaw);
  return tokenCounts;
});

const parent = computed(() => {
  const parentRaw = props.card.labels?.find(
    (l) => l.title === "Forked",
  )?.description;
  if (!parentRaw) return null;
  return parentRaw;
});

const blurred = computed(
  () =>
    props.card.nsfw_image &&
    (config.value?.configs?.theme?.Default?.blur_nsfw ?? blurNsfw.value),
);
</script>

<template>
  <div class="ChubCardPreview">
    <div class="chub-card-preview-image-container">
      <a
        :href="chubAddCardFullPathToUrl(card.fullPath)"
        @click="
          !$event.ctrlKey &&
            (emit('openInFullscreen', card.fullPath), $event.preventDefault())
        "
      >
        <img
          :src="card.avatar_url"
          class="chub-card-preview-image transition-filter"
          :class="{ 'blurred-medium': blurred }"
          alt="Card Image"
        />
      </a>
    </div>
    <div class="chub-card-preview-title">
      <h2 :title="card.name">{{ card.name }}</h2>
    </div>
    <div class="chub-card-preview-stats">
      <div :title="`${card.nMessages} messages`">
        üí¨{{ formatNumberWithMagnitude(card.nMessages) }}
      </div>
      <div :title="`${card.nChats} chats`">
        üìÑ{{ formatNumberWithMagnitude(card.nChats) }}
      </div>
      <div :title="`${card.n_favorites} favorites`">
        ‚≠ê{{ formatNumberWithMagnitude(card.n_favorites) }}
      </div>
      <div :title="`${card.n_public_chats} public chats`">
        üåê{{ formatNumberWithMagnitude(card.n_public_chats) }}
      </div>
      <div :title="`${card.starCount} downloads`">
        ‚¨áÔ∏è{{ formatNumberWithMagnitude(card.starCount) }}
      </div>
    </div>
    <div v-if="tokenCounts" class="chub-card-preview-token-counts-details">
      <div
        :title="`${
          tokenCounts.description +
          tokenCounts.personality +
          tokenCounts.scenario +
          tokenCounts.system_prompt +
          tokenCounts.post_history_instructions
        } permanent tokens`"
      >
        Perm:
        {{
          tokenCounts.description +
          tokenCounts.personality +
          tokenCounts.scenario +
          tokenCounts.system_prompt +
          tokenCounts.post_history_instructions
        }}t
      </div>
      <div
        :title="`${
          tokenCounts.first_mes + tokenCounts.mes_example
        } temporary tokens`"
      >
        Temp: {{ tokenCounts.first_mes + tokenCounts.mes_example }}t
      </div>
    </div>
    <div class="chub-card-preview-metadata-container">
      <div class="buttons">
        <a
          :href="`https://chub.ai/characters/${card.fullPath}`"
          class="chub-card-preview-open-in-chub"
          target="_blank"
        >
          Chub
        </a>
        <button
          class="chub-card-preview-download-button"
          @click="
            chubGetCardByFullPath(card.fullPath, { full: true })
              .then(chubCardToTavernCardFile)
              .then(downloadFile)
          "
        >
          ‚§ì
        </button>
      </div>
      <div>
        by
        <a
          :href="chubAddAuthorToUrl(author)"
          class="button"
          @click="
            !$event.ctrlKey &&
              (emit('searchByAuthor', author), $event.preventDefault())
          "
        >
          {{ author }}
        </a>
      </div>
      <div v-if="parent">
        Forked from
        <a
          :href="chubAddCardFullPathToUrl(parent)"
          class="button"
          @click="
            !$event.ctrlKey &&
              (emit('openInFullscreen', parent), $event.preventDefault())
          "
        >
          {{ parent.replace(/[/][\s\S]+/, "") }}
        </a>
      </div>
      <div class="chub-card-preview-metadata">
        <span>created {{ useTimeAgo(card.createdAt) }}</span>
        <span>updated {{ useTimeAgo(card.lastActivityAt) }}</span>
      </div>
    </div>
    <div
      class="chub-card-preview-tagline"
      v-html="chubMarkdownToHtml(card.tagline, { unsafe: false })"
    ></div>
    <div class="chub-card-preview-topics">
      <a
        v-if="isNsfw"
        class="chub-card-preview-topic button"
        :href="chubAddTopicToUrl('NSFW')"
        @click="
          !$event.ctrlKey && (emit('addTopic', 'NSFW'), $event.preventDefault())
        "
        :title="isShadowNsfw ? 'Shadow NSFW' : 'NSFW'"
      >
        {{ isShadowNsfw ? "(üî•)" : "üî•" }}
      </a>
      <a
        v-if="isNsfl"
        class="chub-card-preview-topic button"
        :href="chubAddTopicToUrl('NSFL')"
        @click="
          !$event.ctrlKey && (emit('addTopic', 'NSFL'), $event.preventDefault())
        "
        :title="isShadowNsfl ? 'Shadow NSFL' : 'NSFL'"
      >
        {{ isShadowNsfl ? "(üíÄ)" : "üíÄ" }}
      </a>
      <template v-for="topic in card.topics" :key="topic">
        <a
          v-if="!CHUB_TAGS_TO_HIDE.includes(topic)"
          class="chub-card-preview-topic button"
          :href="chubAddTopicToUrl(topic)"
          @click="
            !$event.ctrlKey &&
              (emit('addTopic', topic), $event.preventDefault())
          "
        >
          {{ topic }}
        </a>
      </template>
    </div>
  </div>
</template>

<style scoped>
.ChubCardPreview {
  display: flex;
  gap: 0.3em;
  flex-flow: column nowrap;
  align-items: center;
}

.chub-card-preview-title {
  display: grid;
  place-items: center;
  font-size: 110%;
  height: 3lh;
}

h2 {
  margin: 0;
  font-size: 100%;
  text-align: center;
  display: -webkit-box;
  -webkit-box-orient: vertical;
  overflow: hidden;
  -webkit-line-clamp: 3;
  line-clamp: 3;
}

.chub-card-preview-image-container {
  width: 200px;
  height: 200px;
  overflow: hidden;
  border-radius: var(--radius-default);
}

.chub-card-preview-image {
  cursor: pointer;
  height: 200px;
  width: 200px;

  &:hover {
    filter: blur(0) brightness(0.8);
  }
}

.chub-card-preview-tagline {
  display: -webkit-box;
  -webkit-box-orient: vertical;
  overflow: hidden;
  -webkit-line-clamp: 10;
  line-clamp: 10;
  place-items: center;
  max-width: 100%;
  overflow-wrap: break-word;
  text-align: center;
  height: 5lh;
  overflow: auto;
  text-overflow: ellipsis;
}

.chub-card-preview-tagline :deep(p) {
  margin: 0;
}

.chub-card-preview-topics {
  display: flex;
  flex-flow: row wrap;
  justify-content: center;
  max-height: 5lh;
  overflow: auto;
  gap: 0.5em;
  font-size: 85%;
}

.chub-card-preview-topic {
  cursor: pointer;
  background-color: var(--bg-secondary);
  padding: 0.2em 0.5em;
  border-radius: 4px;
}

.chub-card-preview-metadata-container {
  display: flex;
  flex-flow: column nowrap;
  place-items: center;
  gap: 0.3em;
}

.chub-card-preview-stats {
  display: flex;
  flex-flow: row wrap;
  gap: 0.25em;
  justify-content: center;
  font-size: 0.8em;
  opacity: 0.7;
}

.chub-card-preview-metadata {
  display: flex;
  flex-flow: column nowrap;
  gap: 0.25em;
  align-items: center;
  font-size: 0.8em;
  opacity: 0.7;
}

.chub-card-preview-token-counts-details {
  display: flex;
  flex-flow: row wrap;
  gap: 1em;
  justify-content: center;
  font-size: 0.8em;
  opacity: 0.7;
}

.chub-card-preview-open-in-workshop img {
  height: 1lh;
  width: 1lh;
  margin-right: 0.5em;
}

.chub-card-preview-open-in-workshop span {
  vertical-align: top;
}

:deep(img) {
  max-width: 100%;
}
</style>
